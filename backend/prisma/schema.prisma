generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id             String               @id @default(cuid())
  email          String               @unique
  password       String
  firstName      String
  lastName       String
  role           String               @default("EMPLOYEE")
  active         Boolean              @default(true)
  lastLogin      DateTime?
  loginAttempts  Int                  @default(0)
  lockedUntil    DateTime?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  auditLogs      AuditLog[]
  employee       Employee?
  leaveApprovals LeaveApproval[]      @relation("LeaveApprover")
  leaveReviews   LeaveGroupReviewer[]
  tokenBlacklist TokenBlacklist[]

  @@index([email])
  @@index([role])
}

model TokenBlacklist {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model Employee {
  id                String             @id @default(cuid())
  employeeId        String             @unique
  userId            String             @unique
  firstName         String
  lastName          String
  email             String
  phone             String?
  dateOfBirth       DateTime?
  gender            String?
  maritalStatus     String?
  department        String?
  designation       String?
  reportingManager  String?
  dateOfJoining     DateTime
  dateOfLeaving     DateTime?
  employmentType    String             @default("PERMANENT")
  addressLine1      String?
  addressLine2      String?
  city              String?
  state             String?
  zipCode           String?
  country           String?
  panNumber         String?
  aadharNumber      String?
  accountNumber     String?
  ifscCode          String?
  uanNumber         String?
  esicNumber        String?
  status            String             @default("ACTIVE")
  leaveGroupId      String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  attendance        Attendance[]
  complianceRecords ComplianceRecord[]
  leaveGroup        LeaveGroup?        @relation(fields: [leaveGroupId], references: [id])
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  leaveBalances     LeaveBalance[]
  leaveRequests     LeaveRequest[]
  payrolls          Payroll[]
  payslips          Payslip[]
  salaryStructures  SalaryStructure[]
  taxDeclarations   TaxDeclaration[]
  timesheets        Timesheet[]

  @@index([employeeId])
  @@index([department])
  @@index([status])
  @@index([dateOfJoining])
}

model SalaryStructure {
  id             String            @id @default(cuid())
  employeeId     String
  name           String
  effectiveFrom  DateTime
  effectiveUntil DateTime?
  basicSalary    Float
  ctc            Float
  hra            Float?
  dearness       Float?
  conveyance     Float?
  medical        Float?
  other          Float?
  isActive       Boolean           @default(true)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  payrolls       Payroll[]
  components     SalaryComponent[]
  employee       Employee          @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([effectiveFrom])
  @@index([isActive])
}

model SalaryComponent {
  id                String          @id @default(cuid())
  salaryStructureId String
  name              String
  type              String
  calculationType   String
  value             Float
  formula           String?
  dependsOn         String?
  isOptional        Boolean         @default(false)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  salaryStructure   SalaryStructure @relation(fields: [salaryStructureId], references: [id], onDelete: Cascade)

  @@index([salaryStructureId])
  @@index([type])
}

model Payroll {
  id                String             @id @default(cuid())
  employeeId        String
  salaryStructureId String
  month             Int
  year              Int
  status            String             @default("DRAFT")
  basicSalary       Float
  earnings          Float
  deductions        Float
  grossSalary       Float
  netSalary         Float
  pfDeduction       Float              @default(0)
  esiDeduction      Float              @default(0)
  ptDeduction       Float              @default(0)
  tdsDeduction      Float              @default(0)
  daysWorked        Float
  daysPresent       Float
  daysAbsent        Float
  daysLeave         Float
  lockedAt          DateTime?
  processedAt       DateTime?
  rejectionReason   String?
  remarks           String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  complianceRecords ComplianceRecord[]
  employee          Employee           @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  salaryStructure   SalaryStructure    @relation(fields: [salaryStructureId], references: [id])
  payrollComponents PayrollComponent[]
  payslip           Payslip?

  @@unique([employeeId, month, year])
  @@index([employeeId])
  @@index([month, year])
  @@index([status])
  @@index([createdAt])
}

model PayrollComponent {
  id            String   @id @default(cuid())
  payrollId     String
  componentName String
  amount        Float
  type          String
  createdAt     DateTime @default(now())
  payroll       Payroll  @relation(fields: [payrollId], references: [id], onDelete: Cascade)

  @@index([payrollId])
}

model Payslip {
  id           String    @id @default(cuid())
  payrollId    String    @unique
  employeeId   String
  status       String    @default("GENERATED")
  pdfUrl       String?
  sentAt       DateTime?
  viewedAt     DateTime?
  downloadedAt DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  employee     Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  payroll      Payroll   @relation(fields: [payrollId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([status])
}

model Attendance {
  id         String   @id @default(cuid())
  employeeId String
  date       DateTime
  status     String
  remarks    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, date])
  @@index([employeeId])
  @@index([date])
}

model ComplianceRecord {
  id             String    @id @default(cuid())
  employeeId     String
  payrollId      String?
  complianceType String
  amount         Float
  month          Int
  year           Int
  filedAt        DateTime?
  status         String    @default("PENDING")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  employee       Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  payroll        Payroll?  @relation(fields: [payrollId], references: [id])

  @@unique([employeeId, complianceType, month, year])
  @@index([employeeId])
  @@index([complianceType])
}

model TaxDeclaration {
  id               String    @id @default(cuid())
  employeeId       String
  financialYear    String
  section80C       Float     @default(0)
  section80D       Float     @default(0)
  section80E       Float     @default(0)
  section80G       Float     @default(0)
  section80TTA     Float     @default(0)
  totalExemptions  Float     @default(0)
  estimatedTax     Float     @default(0)
  declarationDate  DateTime  @default(now())
  verificationDate DateTime?
  status           String    @default("PENDING")
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  employee         Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, financialYear])
  @@index([employeeId])
  @@index([financialYear])
}

model LeaveType {
  id                    String         @id @default(cuid())
  name                  String
  code                  String         @unique
  description           String?
  maxPerYear            Int
  carryForward          Int
  isCarryForwardAllowed Boolean        @default(true)
  isPaid                Boolean        @default(true)
  requiresDocument      Boolean        @default(false)
  active                Boolean        @default(true)
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  balances              LeaveBalance[]
  requests              LeaveRequest[]

  @@index([code])
}

model LeaveBalance {
  id             String    @id @default(cuid())
  employeeId     String
  leaveTypeId    String
  year           Int
  total          Int
  used           Int
  balance        Int
  carriedForward Int       @default(0)
  lastUpdated    DateTime  @default(now())
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  employee       Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  leaveType      LeaveType @relation(fields: [leaveTypeId], references: [id])

  @@unique([employeeId, leaveTypeId, year])
  @@index([employeeId])
  @@index([year])
}

model LeaveRequest {
  id          String          @id @default(cuid())
  employeeId  String
  leaveTypeId String
  fromDate    DateTime
  toDate      DateTime
  days        Float
  reason      String
  documentUrl String?
  status      String          @default("PENDING")
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  approvals   LeaveApproval[]
  employee    Employee        @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  leaveType   LeaveType       @relation(fields: [leaveTypeId], references: [id])

  @@index([employeeId])
  @@index([status])
  @@index([fromDate, toDate])
}

model LeaveApproval {
  id             String       @id @default(cuid())
  leaveRequestId String
  approverId     String
  level          Int
  status         String       @default("PENDING")
  remarks        String?
  approvedAt     DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  approver       User         @relation("LeaveApprover", fields: [approverId], references: [id])
  leaveRequest   LeaveRequest @relation(fields: [leaveRequestId], references: [id], onDelete: Cascade)

  @@index([leaveRequestId])
  @@index([approverId])
  @@index([status])
}

model LeaveApprovalGroup {
  id             String   @id @default(cuid())
  department     String   @unique
  approvalLevels Int
  approverIds    String[]
  escalationDays Int      @default(5)
  active         Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([active])
}

model LeavePolicy {
  id                 String   @id @default(cuid())
  policyName         String
  companyName        String
  financialYearStart Int
  financialYearEnd   Int
  weekendDays        String[]
  holidayIds         String[]
  lopConfiguration   Json
  encashmentRules    Json
  active             Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  entity    String
  entityId  String
  changes   Json?
  reason    String?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([entityId])
  @@index([createdAt])
}

model PayrollReport {
  id           String   @id @default(cuid())
  reportType   String
  month        Int
  year         Int
  generatedBy  String
  dataSnapshot Json
  createdAt    DateTime @default(now())

  @@index([reportType])
  @@index([month, year])
}

model Timesheet {
  id              String           @id @default(cuid())
  employeeId      String
  weekStartDate   DateTime
  weekEndDate     DateTime
  status          String           @default("DRAFT")
  submittedAt     DateTime?
  approvedAt      DateTime?
  approvedBy      String?
  rejectionReason String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  employee        Employee         @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  entries         TimesheetEntry[]

  @@unique([employeeId, weekStartDate])
  @@index([employeeId])
  @@index([status])
}

model TimesheetEntry {
  id            String    @id @default(cuid())
  timesheetId   String
  date          DateTime
  dayOfWeek     String
  workHours     Float     @default(0)
  sickHours     Float     @default(0)
  personalHours Float     @default(0)
  totalHours    Float     @default(0)
  comments      String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  timesheet     Timesheet @relation(fields: [timesheetId], references: [id], onDelete: Cascade)

  @@unique([timesheetId, date])
  @@index([timesheetId])
}

model LeaveGroup {
  id          String               @id @default(cuid())
  name        String               @unique
  description String?
  active      Boolean              @default(true)
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  employees   Employee[]
  reviewers   LeaveGroupReviewer[]
}

model LeaveGroupReviewer {
  id           String     @id @default(cuid())
  leaveGroupId String
  reviewerId   String
  level        Int
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  leaveGroup   LeaveGroup @relation(fields: [leaveGroupId], references: [id], onDelete: Cascade)
  reviewer     User       @relation(fields: [reviewerId], references: [id])

  @@unique([leaveGroupId, reviewerId])
  @@unique([leaveGroupId, level])
}
